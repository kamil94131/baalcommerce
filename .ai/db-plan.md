# Schemat Bazy Danych dla BaalCommerce

## 1. Lista tabel z ich kolumnami, typami danych i ograniczeniami

### Tabela: `Users`
Ta tabela jest zarządzana przez Supabase.

### Tabela: `Profiles`
Przechowuje metadane użytkownika rozszerzające `auth.users` z Supabase.

| Nazwa kolumny      | Typ danych                 | Ograniczenia                                                                      | Opis                               |
| ------------------ | -------------------------- | --------------------------------------------------------------------------------- | ---------------------------------- |
| `id`               | `bigint`                   | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY`                                 | Unikalny identyfikator profilu.    |
| `userId`           | `uuid`                     | `UNIQUE`, `NOT NULL`, `REFERENCES auth.users(id) ON DELETE CASCADE`               | Klucz obcy do tabeli `auth.users`. |
| `name`             | `varchar(50)`              | `UNIQUE`, `NOT NULL`, `CHECK (length(name) >= 5)`                                 | Unikalna nazwa użytkownika.        |
| `camp`             | `varchar(15)`              | `NOT NULL`, `DEFAULT 'SWAMP_CAMP'`, `CHECK (camp IN ('OLD_CAMP', 'NEW_CAMP', 'SWAMP_CAMP'))` | Obóz użytkownika.                  |
| `defaultCourierId` | `bigint`                   | `REFERENCES Couriers(id) ON DELETE SET NULL`                                      | Domyślny kurier użytkownika (opcjonalnie). |

### Tabela: `Couriers`
Przechowuje informacje o dostępnych kurierach.

| Nazwa kolumny | Typ danych    | Ograniczenia                                                                      | Opis                       |
| ------------- | ------------- | --------------------------------------------------------------------------------- | -------------------------- |
| `id`          | `bigint`      | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY`                                 | Unikalny identyfikator kuriera. |
| `name`        | `varchar(20)` | `UNIQUE`, `NOT NULL`, `CHECK (length(name) >= 5)`                                 | Unikalna nazwa kuriera.    |
| `camp`        | `varchar(15)` | `NOT NULL`, `CHECK (camp IN ('OLD_CAMP', 'NEW_CAMP', 'SWAMP_CAMP'))` | Obóz, z którego pochodzi kurier. |

### Tabela: `Offers`
Przechowuje oferty sprzedaży wystawione przez użytkowników.

| Nazwa kolumny | Typ danych                 | Ograniczenia                                                                      | Opis                               |
| ------------- | -------------------------- | --------------------------------------------------------------------------------- | ---------------------------------- |
| `id`          | `bigint`                   | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY`                                 | Unikalny identyfikator oferty.     |
| `title`       | `varchar(20)`              | `NOT NULL`, `CHECK (length(title) >= 5)`                                          | Tytuł oferty.                      |
| `description` | `varchar(200)`             | `NOT NULL`, `CHECK (length(description) >= 5)`                                    | Opis oferty.                       |
| `price`       | `integer`                  | `NOT NULL`, `CHECK (price BETWEEN 0 AND 999)`                                     | Cena w magicznej rudzie.           |
| `quantity`    | `integer`                  | `NOT NULL`, `CHECK (quantity BETWEEN 1 AND 99)`                                   | Dostępna ilość.                    |
| `createdAt`   | `timestamp with time zone` | `NOT NULL`, `DEFAULT now()`                                                       | Data utworzenia oferty.            |
| `sellerId`    | `uuid`                     | `NOT NULL`, `REFERENCES auth.users(id) ON DELETE CASCADE`                         | ID sprzedawcy (z `auth.users`).    |
| `sellerName`  | `varchar(50)`              | `NOT NULL`                                                                        | Nazwa sprzedawcy (zdenormalizowana). |
| `sellerCamp`  | `varchar(15)`              | `NOT NULL`                                                                        | Obóz sprzedawcy (zdenormalizowany). |
| `status`      | `varchar(10)`              | `NOT NULL`, `DEFAULT 'CREATED'`, `CHECK (status IN ('CREATED', 'DONE'))`          | Status oferty.                     |

### Tabela: `Orders`
Zdenormalizowana tabela przechowująca historyczne dane o zrealizowanych zamówieniach.

| Nazwa kolumny | Typ danych                 | Ograniczenia                                                                      | Opis                                         |
| ------------- | -------------------------- | --------------------------------------------------------------------------------- | -------------------------------------------- |
| `id`          | `bigint`                   | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY`                                 | Unikalny identyfikator zamówienia.           |
| `offerId`     | `bigint`                   | `REFERENCES Offers(id) ON DELETE RESTRICT`                                        | ID powiązanej oferty.                        |
| `title`       | `varchar(20)`              | `NOT NULL`                                                                        | Tytuł oferty w momencie zakupu.              |
| `quantity`    | `integer`                  | `NOT NULL`                                                                        | Ilość w momencie zakupu.                     |
| `price`       | `integer`                  | `NOT NULL`                                                                        | Cena w momencie zakupu.                      |
| `sellerName`  | `varchar(50)`              | `NOT NULL`                                                                        | Nazwa sprzedawcy w momencie zakupu.          |
| `sellerCamp`  | `varchar(15)`              | `NOT NULL`                                                                        | Obóz sprzedawcy w momencie zakupu.           |
| `sellerId`    | `uuid`                     | `REFERENCES auth.users(id) ON DELETE SET NULL`                                    | ID sprzedawcy (z `auth.users`).              |
| `buyerId`     | `uuid`                     | `NOT NULL`, `REFERENCES auth.users(id) ON DELETE SET NULL`                        | ID kupującego (z `auth.users`).              |
| `buyerName`   | `varchar(50)`              | `NOT NULL`                                                                        | Nazwa kupującego w momencie zakupu.          |
| `buyerCamp`   | `varchar(15)`              | `NOT NULL`                                                                        | Obóz kupującego w momencie zakupu.           |
| `courierId`   | `bigint`                   | `NOT NULL`, `REFERENCES Couriers(id) ON DELETE RESTRICT`                          | ID kuriera obsługującego zamówienie.         |
| `deliveredAt` | `timestamp with time zone` | `NOT NULL`, `DEFAULT now()`                                                       | Data zrealizowania zamówienia.               |

### Tabela: `Roles`
Słownik ról w systemie.

| Nazwa kolumny | Typ danych    | Ograniczenia                                      | Opis                         |
| ------------- | ------------- | ------------------------------------------------- | ---------------------------- |
| `id`          | `integer`     | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY` | Unikalny identyfikator roli. |
| `name`        | `varchar(10)` | `UNIQUE`, `NOT NULL`, `CHECK (length(name) >= 5)` | Nazwa roli (np. 'gomez').    |

### Tabela: `UserRoles`
Tabela łącząca użytkowników z rolami (relacja wiele-do-wielu).

| Nazwa kolumny | Typ danych | Ograniczenia                                      | Opis                               |
| ------------- | ---------- | ------------------------------------------------- | ---------------------------------- |
| `userId`      | `uuid`     | `REFERENCES auth.users(id) ON DELETE CASCADE`     | ID użytkownika (z `auth.users`).   |
| `roleId`      | `integer`  | `REFERENCES Roles(id) ON DELETE CASCADE`          | ID roli (z tabeli `Roles`).        |
| `(userId, roleId)` | -       | `PRIMARY KEY`                                     | Klucz główny złożony.              |

## 2. Relacje między tabelami

- **`auth.users` ↔ `Profiles` (1 do 1):** Każdy użytkownik w `auth.users` ma dokładnie jeden profil w `Profiles`. Usunięcie użytkownika powoduje kaskadowe usunięcie jego profilu.
- **`Profiles` ↔ `Offers` (1 do N):** Jeden profil (sprzedawca) może mieć wiele ofert. Usunięcie profilu sprzedawcy (przez usunięcie użytkownika) powoduje kaskadowe usunięcie wszystkich jego ofert.
- **`Profiles` ↔ `Orders` (1 do N):** Jeden profil może być kupującym (`buyerId`) lub sprzedającym (`sellerId`) w wielu zamówieniach. Usunięcie profilu powoduje ustawienie `buyerId` lub `sellerId` na `NULL`.
- **`Couriers` ↔ `Orders` (1 do N):** Jeden kurier może być przypisany do wielu zamówień. Usunięcie kuriera jest zablokowane (`RESTRICT`), jeśli jest on powiązany z jakimkolwiek zamówieniem.
- **`Offers` ↔ `Orders` (1 do 1):** Jedna oferta może być powiązana z jednym zamówieniem. Usunięcie oferty jest zablokowane (`RESTRICT`), jeśli jest powiązana z zamówieniem.
- **`auth.users` ↔ `Roles` (N do N):** Relacja zrealizowana przez tabelę `UserRoles`. Jeden użytkownik może mieć wiele ról, a jedna rola może być przypisana do wielu użytkowników.

## 3. Indeksy

W celu optymalizacji wydajności zapytań, zostaną utworzone następujące indeksy:

- **Indeksy na kluczach obcych:**
  - `Profiles(userId)`
  - `Profiles(defaultCourierId)`
  - `Offers(sellerId)`
  - `Orders(offerId)`
  - `Orders(sellerId)`
  - `Orders(buyerId)`
  - `Orders(courierId)`
  - `UserRoles(userId)`
  - `UserRoles(roleId)`
- **Indeksy na często filtrowanych kolumnach:**
  - `Offers(status)`
- **Indeksy unikalności (automatycznie tworzone przez ograniczenie `UNIQUE`):**
  - `Profiles(name)`
  - `Couriers(name)`
  - `Roles(name)`

## 4. Zasady PostgreSQL (Row-Level Security)

Dostęp do danych będzie kontrolowany za pomocą polityk RLS.

- **Funkcja pomocnicza do sprawdzania ról:**
  ```sql
  CREATE OR REPLACE FUNCTION has_role(role_name text)
  RETURNS boolean AS $$
  BEGIN
    RETURN EXISTS (
      SELECT 1
      FROM "UserRoles" ur
      JOIN "Roles" r ON ur."roleId" = r.id
      WHERE ur."userId" = auth.uid() AND r.name = role_name
    );
  END;
  $$ LANGUAGE plpgsql SECURITY DEFINER;
  ```

- **Tabela `Profiles`:**
  - **`SELECT`:** Dostęp publiczny.
    ```sql
    CREATE POLICY "Allow public read access" ON "Profiles" FOR SELECT USING (true);
    ```
  - **`UPDATE`:** Użytkownicy mogą modyfikować tylko własny profil.
    ```sql
    CREATE POLICY "Allow individual update access" ON "Profiles" FOR UPDATE USING (auth.uid() = "userId");
    ```

- **Tabela `Offers`:**
  - **`SELECT`:** Dostęp publiczny dla aktywnych ofert.
    ```sql
    CREATE POLICY "Allow public read access for active offers" ON "Offers" FOR SELECT USING (status = 'CREATED');
    ```
  - **`INSERT`:** Każdy zalogowany użytkownik może tworzyć oferty.
    ```sql
    CREATE POLICY "Allow insert for authenticated users" ON "Offers" FOR INSERT WITH CHECK (auth.role() = 'authenticated');
    ```
  - **`UPDATE` / `DELETE`:** Tylko autor oferty może ją modyfikować lub usunąć.
    ```sql
    CREATE POLICY "Allow individual update/delete access" ON "Offers" FOR (UPDATE, DELETE) USING (auth.uid() = "sellerId");
    ```

- **Tabela `Orders`:**
  - **`SELECT`:** Użytkownicy mogą widzieć tylko zamówienia, w których są kupującym lub sprzedającym.
    ```sql
    CREATE POLICY "Allow individual read access" ON "Orders" FOR SELECT USING (auth.uid() = "buyerId" OR auth.uid() = "sellerId");
    ```
  - **`INSERT`:** Każdy zalogowany użytkownik może tworzyć zamówienia (kupować).
    ```sql
    CREATE POLICY "Allow insert for authenticated users" ON "Orders" FOR INSERT WITH CHECK (auth.role() = 'authenticated');
    ```

- **Tabela `Couriers`:**
  - **`SELECT` / `INSERT`:** Dostęp dla wszystkich zalogowanych użytkowników.
    ```sql
    CREATE POLICY "Allow read/insert for authenticated users" ON "Couriers" FOR (SELECT, INSERT) USING (auth.role() = 'authenticated');
    ```
  - **`DELETE`:** Tylko użytkownicy z rolą `gomez`.
    ```sql
    CREATE POLICY "Allow delete for gomez role" ON "Couriers" FOR DELETE USING (has_role('gomez'));
    ```

## 5. Wszelkie dodatkowe uwagi lub wyjaśnienia dotyczące decyzji projektowych

1.  **Denormalizacja tabeli `Orders`:** Tabela `Orders` celowo przechowuje zduplikowane dane (`title`, `price`, `sellerName` etc.). Jest to zgodne z decyzją projektową, aby zapewnić historyczną integralność i niezmienność danych zamówienia, nawet jeśli oryginalna oferta lub profile użytkowników ulegną zmianie.
2.  **Integralność referencyjna:** Zastosowano różne strategie `ON DELETE` (`CASCADE`, `SET NULL`, `RESTRICT`), aby zapewnić spójność danych w całej bazie w zależności od kontekstu biznesowego.
3.  **Transakcyjność:** Atomowość operacji tworzenia zamówienia i jednoczesnej aktualizacji statusu oferty (`CREATED` -> `DONE`) musi być zapewniona na poziomie kodu aplikacji poprzez opakowanie obu operacji w transakcję bazodanową.
4.  **Zarządzanie kurierami (MVP):** Zgodnie z notatkami, w ramach MVP nie zaimplementowano mechanizmu "miękkiego usuwania" (soft delete) dla kurierów. Oznacza to, że kurier powiązany z historycznym zamówieniem nie może zostać usunięty, ale nie ma też sposobu, aby oznaczyć go jako nieaktywnego dla przyszłych zamówień. Jest to znane ograniczenie.
